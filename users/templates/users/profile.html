
{% extends "users/base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'users/style.css' %}">


<h1 class="text-lg lg:text-xl xl:text-2xl w-full
 overflow-hidden text-ellipsis
 whitespace-nowrap mt-5 mb-5" style="margin-left: 10px">
    <span class="pl-3 lg:pl-0 sm:pl-0">Hi,</span>&nbsp;
    <span class="font-semibold">{{ user.username.title }}</span>
</h1>

<div class="container text-center">
  <div class="row">
    <div class="col-8">
      <form method="post">
        {% csrf_token %}
        <div class="card text-center mb-4  shadow bg-light">
            <div class="card-header text-secondary">
                <h3>Voice Journaling</h3>
            </div>
            <div class="card-body">
                <p id="transcript" class="card-text text-dark"></p>
                {{ form_2|crispy }}
                <input class="btn btn-secondary btn-lg" type="submit">
            </div>
            <div class="card-footer text-body-secondary">
                <div class="button-group mb-3">
                    <button id="startRecording" class="btn btn-success btn-lg">Start Recording</button>
                    <button id="stopRecording" class="btn btn-danger btn-lg" disabled>Stop Recording</button>
                </div>
            </div>
        </div>
      </form>
    </div>

    <div class="col-4">
      <div class="card" style="height: 15rem;">
          <img src="https://img.freepik.com/free-photo/galaxy-nature-aesthetic-background-starry-sky-mountain-remixed-media_53876-126761.jpg?ga=GA1.1.1135514170.1736493801&semt=ais_hybrid" class="card-img-top" alt="...">
          <div class="card-body">
            <h3 class="card-title">The Quote:</h3>
            <p class="card-text">Some quick example text to build on the card title and make up the bulk of
                Some quick example text to build on the card title and make up the bulk of the card's content.
                Some quick example text to build on the card title and make up the bulk of the card's content.
                the card's content.</p>
            <ul class="list-group list-group-flush">
<!--                <li class="list-group-item"></li>-->
<!--                <li class="list-group-item">A second item</li>-->
<!--                <li class="list-group-item">A third item</li>-->
<!--                <li class="list-group-item">A third item</li>-->
                <a class="btn btn-dark btn-sm mt-1 mb-2" href="{% url 'journal' %}" >All Journals</a>
                <a class="btn btn-dark btn-sm mt-1 mb-2" href="{% url 'mood' %}">Mood History</a>
                <a class="btn btn-dark btn-sm mt-1 mb-2" href="{% url 'profile' %}">Dashboard</a>
                <a class="btn btn-dark btn-sm mt-1 mb-2" href="{% url 'logout' %}">Sign out</a>
            </ul>
          </div>
      </div>
    </div>
  </div>
</div>


<div class="container text-center">
  <div class="row">
    <div class="col-8">
      <form method="post">
                {% csrf_token %}
          <div class="card text-center mb-5 mt-3 shadow bg-light">
              <div class="card-header text-secondary">
                  <h3>Text Journaling </h3>
              </div>
              <div class="card-body">
                  {{ form|crispy }}
              </div>
              <div class="card-footer text-body-secondary">
                  <input class="btn btn-secondary btn-lg" type="submit">
              </div>
          </div>
      </form>
    </div>
  </div>
</div>


<!--<div class="flex-container mt-5" >{{ mood|safe }}</div>-->




<script>
    let mediaRecorder;
    let socket;

// Function to start transcription
function startTranscription() {
    navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
        if (!MediaRecorder.isTypeSupported("audio/webm")) {
            return alert("Browser not supported");
        }

        mediaRecorder = new MediaRecorder(stream, {
            mimeType: "audio/webm",
        });

        socket = new WebSocket("ws://localhost:8000/register/profile/ws/listen/");

        socket.onopen = () => {
            mediaRecorder.addEventListener("dataavailable", (event) => {
                if (event.data.size > 0 && socket.readyState === 1) {
                    socket.send(event.data);
                }
            });
            mediaRecorder.start(250); // Send audio chunks every 250ms
        };

        socket.onmessage = (message) => {
            const received = message.data;
            if (received) {
                // Update the content field with the transcribed text
                const contentField = document.querySelector("#id_content");
                if (contentField) {
                    contentField.value += " " + received.trim();
                } else {
                    console.error("Content field not found.");
                }
            }
        };

        socket.onerror = (error) => {
            console.error("WebSocket Error:", error);
        };
    });

    // Enable Stop button and disable Start button
    document.getElementById("startRecording").disabled = true;
    document.getElementById("stopRecording").disabled = false;
}

// Function to stop transcription
function stopTranscription() {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
    }

    if (socket && socket.readyState === 1) {
        socket.close();
    }

    // Enable Start button and disable Stop button
    document.getElementById("startRecording").disabled = false;
    document.getElementById("stopRecording").disabled = true;
}

// Add event listeners to buttons
document.getElementById("startRecording").addEventListener("click", startTranscription);
document.getElementById("stopRecording").addEventListener("click", stopTranscription);

</script>
{% endblock content %}